{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>{% block title %}FoodieNet{% endblock %}</title>
  <link href="{% static 'css/output.css' %}" rel="stylesheet">
  <style>
    body {
      background-image: url('{% static "images/prueba3.jpg" %}');
      background-size: cover;
      background-position: center;
      background-attachment: fixed;
      background-repeat: no-repeat;
    }
  </style>
</head>
<body class="min-h-screen font-sans text-gray-800">

  <div class="min-h-screen flex flex-col">

    <!-- Header -->
   <header class="relative h-[360px] flex flex-col justify-between text-white">
   <div class="absolute inset-0 bg-black/50 pointer-events-none"></div>

  <!-- Navbar -->
  <div class="relative z-10 w-11/12 max-w-7xl mx-auto flex justify-between items-center py-4">
    <div class="flex items-center gap-6">
      <a href="{% url 'lista_recetas' %}" class="text-3xl font-extrabold tracking-wide hover:text-orange-400 transition duration-300">
        FoodieNet
      </a>
      <nav class="hidden md:flex gap-6">
        <a href="{% url 'lista_recetas' %}" class="hover:text-orange-400 transition duration-300">Inicio</a>
        {% if user.is_authenticated %}
          <a href="{% url 'feed_amigos' %}" class="hover:text-orange-400 transition duration-300">Feed Amigos</a>
          <a href="{% url 'crear_receta' %}" class="hover:text-orange-400 transition duration-300">Nueva Receta</a>
          <a href="{% url 'lista_planes_semanales' %}" class="hover:text-orange-400 transition duration-300">Planes semanales</a>
          <a href="{% url 'grupos:explorar_grupos' %}" class="hover:text-orange-400 transition duration-300">Grupos</a>
        {% endif %}
      </nav>
    </div>

    <!-- Buscador + filtros + notificaciones + perfil -->
    <div class="flex items-center gap-4">

<!-- Buscador + filtros -->
<!-- Buscador + filtros -->
<div class="relative z-[9999]">
  <form method="get" action="{% url 'users:buscar_usuarios_y_recetas' %}">
    <div class="flex items-center gap-2">
      <input type="text" name="query" placeholder="Buscar..."
             value="{{ request.GET.query|default:'' }}"
             class="flex-1 px-3 py-2 border border-gray-300 rounded-l-md focus:ring-2 focus:ring-orange-400 focus:outline-none text-gray-800 transition duration-300">
      <button type="submit"
              class="px-4 py-2 bg-gradient-to-r from-orange-500 to-pink-500 hover:from-pink-500 hover:to-orange-500 text-white rounded-r-md font-semibold transition duration-500 shadow-lg">
        游댌
      </button>
      <!-- Bot칩n de filtros solo para mostrar/ocultar el dropdown -->
      <button type="button" id="filtros-btn"
              class="ml-2 px-3 py-2 border border-gray-300 rounded-md bg-white text-gray-700 hover:bg-gray-100 transition">
        Filtros
      </button>
    </div>

    <!-- Dropdown de filtros -->
    <div id="filtros-dropdown"
         class="absolute right-0 top-full mt-1 w-full bg-white border border-gray-200 rounded-md shadow-lg p-4 hidden text-gray-800">
      
      <select name="dificultad" class="px-2 py-1 border rounded-md w-full text-gray-800 bg-white">
        <option value="">Dificultad</option>
        <option value="f치cil" {% if request.GET.dificultad == 'f치cil' %}selected{% endif %}>F치cil</option>
        <option value="media" {% if request.GET.dificultad == 'media' %}selected{% endif %}>Media</option>
        <option value="dif칤cil" {% if request.GET.dificultad == 'dif칤cil' %}selected{% endif %}>Dif칤cil</option>
      </select>

      <div class="flex gap-2 mt-2">
        <input type="number" name="min_calorias" placeholder="Min Cal" value="{{ request.GET.min_calorias|default:'' }}"
                class="px-2 py-1 border rounded-md flex-1 min-w-0 text-gray-800 bg-white">
        <input type="number" name="max_calorias" placeholder="Max Cal" value="{{ request.GET.max_calorias|default:'' }}"
                class="px-2 py-1 border rounded-md flex-1 min-w-0 text-gray-800 bg-white">
      </div>

      <input type="text" name="tags" placeholder="Tags (separados por comas)" value="{{ request.GET.tags|default:'' }}"
             class="px-2 py-1 border rounded-md w-full text-gray-800 bg-white mt-2">

      <div class="flex gap-2 mt-2">
        <input type="date" name="fecha_desde" value="{{ request.GET.fecha_desde|default:'' }}"
               class="px-2 py-1 border rounded-md flex-1 min-w-0 text-gray-800 bg-white">
        <input type="date" name="fecha_hasta" value="{{ request.GET.fecha_hasta|default:'' }}"
               class="px-2 py-1 border rounded-md flex-1 min-w-0 text-gray-800 bg-white">
      </div>

      <!-- Bot칩n limpiar filtros -->
      <button type="button" id="limpiar-filtros"
              class="mt-3 w-full bg-gray-200 text-gray-800 py-2 rounded-md hover:bg-gray-300 transition">
        Limpiar filtros
      </button>
    </div>
  </form>
</div>


      {% if user.is_authenticated %}
        <!-- Dropdown Notificaciones -->
        <div class="relative ml-2">
          <button id="noti-btn" class="relative flex items-center focus:outline-none transition duration-300 text-2xl">
            游댒
            {% if notificaciones_total > 0 %}
              <span
                class="absolute -top-1 -right-1 bg-red-500 text-white text-xs w-5 h-5 rounded-full flex items-center justify-center">
                {{ notificaciones_total }}
              </span>
            {% endif %}
          </button>

          <div id="noti-dropdown"
               class="absolute right-0 mt-2 w-80 text-gray-800 rounded-lg shadow-lg hidden z-50 border border-gray-200 bg-white">
            <div class="p-2 font-semibold border-b flex justify-between items-center">
              <span>Notificaciones</span>
              <button onclick="marcarTodasLeidas()" class="text-sm text-blue-500 hover:underline">Marcar todas como le칤das</button>
            </div>
            <ul id="noti-list" class="max-h-64 overflow-y-auto">
              {% for n in notificaciones %}
                {% if not n.leida %}
                  <li class="p-2 hover:bg-gray-100 border-b flex flex-col cursor-pointer"
                      onclick="marcarLeida({{ n.pk }}, this)">
                    <span>{{ n.mensaje }}</span>
                    <span class="text-xs text-gray-400">{{ n.fecha|date:"d M Y H:i" }}</span>
                  </li>
                {% endif %}
              {% empty %}
                <li class="p-2 text-gray-500">No tienes notificaciones</li>
              {% endfor %}
            </ul>
            <div class="relative z-50">
              <a href="{% url 'notifications:ver_todas' %}"
                 class="block text-center p-2 bg-gray-100 hover:bg-gray-200 rounded-b-lg">
                 Ver todas
              </a>
            </div>
          </div>
        </div>

        <!-- Dropdown Perfil -->
        <div class="relative ml-2">
          <button id="perfil-btn" class="flex items-center gap-2 focus:outline-none transition duration-300">
            <img src="{{ user.perfil.get_foto_url }}" alt="Foto perfil {{ user.username }}"
                 class="w-10 h-10 rounded-full object-cover border-2 border-white shadow-lg">
            <span class="hidden sm:inline font-semibold">{{ user.username }}</span>
            <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7"/>
            </svg>
          </button>

          <div id="perfil-dropdown" class="absolute right-0 mt-2 w-48 bg-white text-gray-800 rounded-lg shadow-lg hidden z-50">
            <a href="{% url 'users:perfil' %}" class="block px-4 py-2 hover:bg-gray-100 transition duration-300">Ir a mi perfil</a>
            <form method="post" action="{% url 'authentication:logout' %}">
              {% csrf_token %}
              <button type="submit" class="w-full text-left px-4 py-2 hover:bg-gray-100 transition duration-300">Cerrar sesi칩n</button>
            </form>
          </div>
        </div>
      {% else %}
        <a href="{% url 'authentication:login' %}"
           class="px-4 py-2 rounded-lg border border-white hover:bg-white hover:text-orange-600 transition duration-300">Iniciar sesi칩n</a>
        <a href="{% url 'authentication:register' %}"
           class="px-4 py-2 rounded-lg bg-gradient-to-r from-orange-500 to-pink-500 hover:from-pink-500 hover:to-orange-500 font-semibold transition duration-500 shadow-lg">Registrarse</a>
      {% endif %}
    </div>
  </div>

  <!-- Tagline -->
<div class="relative z-0 text-center mt-12 max-w-7xl mx-auto px-4">
  <h1 class="text-4xl md:text-6xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-orange-400 via-red-500 to-pink-500 drop-shadow-lg animate-pulse">
    Comparte y descubre recetas incre칤bles
  </h1>
  <p class="mt-3 text-lg text-white drop-shadow-md">
    칔nete a la comunidad de FoodieNet y lleva tu pasi칩n por la cocina al siguiente nivel.
  </p>
</div>

</header>

    <main class="flex-grow w-11/12 max-w-5xl mx-auto mt-8 bg-white shadow-lg rounded-xl p-6 transition-all duration-500 hover:shadow-2xl">
      {% block content %}{% endblock %}
    </main>

    <!-- Footer -->
    <footer class="bg-gray-900 text-gray-400 text-center py-6 mt-8 transition duration-300">
      춸 {% now "Y" %} <span class="text-white font-semibold">FoodieNet</span>. Todos los derechos reservados.
    </footer>

  </div>

  {% block extra_scripts %}{% endblock %}
</body>
</html>

<script>
const btnFiltros = document.getElementById('filtros-btn');
const dropdownFiltros = document.getElementById('filtros-dropdown');
const btnLimpiar = document.getElementById('limpiar-filtros');
const formFiltros = dropdownFiltros.closest('form');

// Toggle del dropdown
btnFiltros.addEventListener('click', (e) => {
  e.stopPropagation();
  dropdownFiltros.classList.toggle('hidden');
});

// Cerrar dropdown si clic fuera
document.addEventListener('click', (e) => {
  if (!btnFiltros.contains(e.target) && !dropdownFiltros.contains(e.target)) {
    dropdownFiltros.classList.add('hidden');
  }
});

// Limpiar filtros y hacer submit
btnLimpiar.addEventListener('click', () => {
  formFiltros.querySelectorAll('input, select').forEach(el => el.value = '');
  formFiltros.submit();
});

// Enviar form al presionar Enter en cualquier input de filtro
dropdownFiltros.querySelectorAll('input, select').forEach(el => {
  el.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
      formFiltros.submit();
    }
  });
});

  // Dropdown Notificaciones
  const notiBtn = document.getElementById('noti-btn');
  const notiDropdown = document.getElementById('noti-dropdown');

  notiBtn.addEventListener('click', function(e) {
    e.stopPropagation();
    notiDropdown.classList.toggle('hidden');
  });

  // Dropdown Perfil
  const perfilBtn = document.getElementById('perfil-btn');
  const perfilDropdown = document.getElementById('perfil-dropdown');

  perfilBtn.addEventListener('click', function(e) {
    e.stopPropagation();
    perfilDropdown.classList.toggle('hidden');
  });

  // Cerrar dropdowns con clic fuera
  document.addEventListener('click', function(e) {
    if (!notiDropdown.contains(e.target) && e.target !== notiBtn) {
      notiDropdown.classList.add('hidden');
    }
    if (!perfilDropdown.contains(e.target) && e.target !== perfilBtn) {
      perfilDropdown.classList.add('hidden');
    }
  });

  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
      notiDropdown.classList.add('hidden');
      perfilDropdown.classList.add('hidden');
      dropdownFiltros.classList.add('hidden');
    }
  });

  // Funciones de notificaciones
  function marcarLeida(pk, element) {
    fetch(`/notificaciones/marcar-leida/${pk}/`)
      .then(() => {
        element.remove();
        const contador = document.querySelector('#noti-btn span');
        if (contador) {
          let total = parseInt(contador.textContent) - 1;
          if (total > 0) {
            contador.textContent = total;
          } else {
            contador.remove();
          }
        }
      });
  }

  function marcarTodasLeidas() {
    fetch(`/notificaciones/marcar-todas/`)
      .then(() => {
        const lista = document.getElementById('noti-list');
        lista.innerHTML = '<li class="p-2 text-gray-500">No tienes notificaciones</li>';
        const contador = document.querySelector('#noti-btn span');
        if (contador) contador.remove();
      });
  }
</script>