{% extends "base.html" %}
{% load static %}

{% load filtros_amigos %}
{% load recetas_extras %}


{% block title %}Mi perfil – FoodieNet{% endblock %}

{% block content %}
<div class="container mx-auto my-8 px-4">
  <h1 class="text-3xl font-bold mb-6 text-gray-900">Mi perfil</h1>

  <!-- Fondo para secciones -->
  <div class="bg-white rounded-xl p-6 shadow-lg space-y-6">

    <!-- Sección de información del usuario -->
    <div class="flex flex-col md:flex-row items-center md:items-start gap-6">
      {% if request.user.perfil.foto %}
        <img src="{{ request.user.perfil.foto.url }}"
             alt="Foto de {{ request.user.username }}"
             class="rounded-full w-24 h-24 object-cover border-2 border-gray-300 shadow-md">
      {% else %}
        <img src="{% static 'perfiles/default.jpeg' %}"
             alt="Foto de perfil por defecto"
             class="rounded-full w-24 h-24 object-cover border-2 border-gray-300 shadow-md">
      {% endif %}

      <div class="flex-1 text-gray-900">
        <p class="mb-1"><strong>Nombre de usuario:</strong> {{ request.user.username }}</p>
        <p class="mb-1"><strong>Correo:</strong> {{ request.user.email }}</p>
        <p class="mb-1"><strong>Biografía:</strong> {{ request.user.perfil.biografia|default:"(sin biografía)" }}</p>
        <a href="{% url 'users:editar_perfil' %}" 
           class="mt-2 inline-block bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition">
          Editar mi perfil
        </a>
          <!-- Botón para editar preferencias y alergias -->
  <a href="{% url 'users:editar_preferencias' %}" 
     class="mt-2 inline-block bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 transition">
    Editar preferencias y alergias
  </a>

<p class="mt-2 text-gray-700 text-sm">
  {% with request.user.perfil.preferencias.all as prefs %}
    {% if prefs %}
      Has marcado {{ prefs|length }} preferencia{% if prefs|length > 1 %}s{% endif %}
    {% else %}
      No has marcado preferencias ni alergias
    {% endif %}
  {% endwith %}
</p>

</div>
</div>
      </div>
    </div>

    <!-- Solicitudes de amistad -->
    <div class="relative">
      <button id="dropdownSolicitudes" 
              class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600 transition">
        Solicitudes de amistad (<span id="countSolicitudes">{{ solicitudes_pendientes.count }}</span>)
      </button>
      <ul id="listaSolicitudes" 
          class="absolute mt-2 bg-white border rounded shadow w-80 hidden z-10">
        {% if solicitudes_pendientes %}
          {% for solicitud in solicitudes_pendientes %}
            <li id="solicitud-{{ solicitud.id }}" 
                class="flex justify-between items-center px-4 py-2 hover:bg-gray-100">
              <span>{{ solicitud.de_usuario.username }}</span>
              <div class="flex gap-2">
                <button class="aceptar-btn bg-green-500 text-white px-2 py-1 rounded hover:bg-green-600 transition" 
                        data-id="{{ solicitud.id }}">Aceptar</button>
                <button class="rechazar-btn bg-red-500 text-white px-2 py-1 rounded hover:bg-red-600 transition" 
                        data-id="{{ solicitud.id }}">Rechazar</button>
              </div>
            </li>
          {% endfor %}
        {% else %}
          <li id="noSolicitudes" class="text-gray-500 px-4 py-2">No hay solicitudes pendientes</li>
        {% endif %}
      </ul>
    </div>

    <!-- Amigos -->
    <h2 class="text-2xl font-semibold text-gray-900">Mis amigos</h2>
    <ul id="listaAmigos" class="mb-6">
      {% if amigos %}
        {% for amigo in amigos %}
          <li class="flex items-center gap-2 mb-2">
            <a href="{% url 'users:perfil_usuario' amigo.username %}" 
               class="flex items-center gap-2 text-gray-900 hover:underline">
              {% if amigo.perfil.foto %}
                <img src="{{ amigo.perfil.foto.url }}" 
                     alt="Avatar de {{ amigo.username }}"
                     class="w-10 h-10 rounded-full border border-gray-400 object-cover">
              {% else %}
                <img src="{% static 'perfiles/default.jpeg' %}" 
                     alt="Avatar por defecto"
                     class="w-10 h-10 rounded-full border border-gray-400 object-cover">
              {% endif %}
              <span>{{ amigo.username }}</span>
            </a>
          </li>
        {% endfor %}
      {% else %}
        <li id="sinAmigos" class="text-gray-500">No tienes amigos aún.</li>
      {% endif %}
    </ul>

    <!-- Recetas subidas -->
    <h2 class="text-2xl font-semibold text-gray-900">Mis recetas subidas</h2>
    {% if recetas %}
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        {% for r in recetas %}
          <div class="border rounded shadow overflow-hidden bg-white">
            {% if r.imagen %}
              <img src="{{ r.imagen.url }}" alt="{{ r.titulo }}" class="w-full h-48 object-cover">
            {% endif %}
            <div class="p-4">
              <h5 class="font-semibold text-lg">
                <a href="{% url 'detalle_receta' r.pk %}" class="hover:underline text-gray-900">{{ r.titulo }}</a>
              </h5>
              <span class="inline-block mt-1 px-2 py-1 text-sm rounded {{ r.es_publica|badge_class }}">
                {{ r.es_publica|badge_label }}
              </span>
            </div>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <p class="text-gray-800">No has subido ninguna receta aún.</p>
    {% endif %}

    <!-- Recetas favoritas -->
    <h2 class="text-2xl font-semibold text-gray-900">Mis recetas favoritas</h2>
    {% if favoritos %}
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        {% for fav in favoritos %}
          <div class="border rounded shadow overflow-hidden bg-white">
            {% if fav.receta.imagen %}
              <img src="{{ fav.receta.imagen.url }}" alt="{{ fav.receta.titulo }}" class="w-full h-48 object-cover">
            {% endif %}
            <div class="p-4">
              <h5 class="font-semibold text-lg">
                <a href="{% url 'detalle_receta' fav.receta.pk %}" class="hover:underline text-gray-900">
                  {{ fav.receta.titulo }}
                </a>
              </h5>
              <p class="mt-1 text-gray-700">
                Por <a href="{% url 'users:perfil_usuario' fav.receta.autor.username %}" class="hover:underline">
                  {{ fav.receta.autor.username }}
                </a>
              </p>
            </div>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <p class="text-gray-800">No tienes recetas favoritas aún.</p>
    {% endif %}

  </div>
</div>




<script>
document.addEventListener('DOMContentLoaded', function() {
  function actualizarListaAmigos(amigos) {
    const lista = document.getElementById('listaAmigos');
    lista.innerHTML = '';
    if (amigos.length === 0) {
      lista.innerHTML = '<li class="list-group-item text-muted" id="sinAmigos">No tienes amigos aún.</li>';
    } else {
      amigos.forEach(amigo => {
        const li = document.createElement('li');
        li.className = 'list-group-item d-flex align-items-center gap-2';
        const a = document.createElement('a');
        a.href = `/users/${amigo.username}/`;
        a.className = 'd-flex align-items-center text-decoration-none text-dark';

        const img = document.createElement('img');
        img.src = amigo.perfil_foto_url;  // asegúrate que la API JSON te devuelva esta URL
        img.alt = `Avatar de ${amigo.username}`;
        img.width = 32;
        img.height = 32;
        img.className = 'rounded-circle border border-secondary';
        img.style.objectFit = 'cover';

        const span = document.createElement('span');
        span.textContent = amigo.username;

        a.appendChild(img);
        a.appendChild(span);
        li.appendChild(a);
        lista.appendChild(li);
      });
    }
  }

  // Toggle dropdown de solicitudes
  document.getElementById('dropdownSolicitudes').addEventListener('click', () => {
    document.getElementById('listaSolicitudes').classList.toggle('hidden');
  });

  function actualizarSolicitudesPendientes(solicitudId) {
  const li = document.getElementById('solicitud-' + solicitudId);
  if (li) li.remove();
  const listaSolicitudes = document.getElementById('listaSolicitudes');
  if (!listaSolicitudes.querySelector('.dropdown-item')) {
    listaSolicitudes.innerHTML = '<li class="dropdown-item text-muted" id="noSolicitudes">No hay solicitudes pendientes</li>';
  }
  const countElem = document.getElementById('countSolicitudes');
  const nuevasSolicitudes = listaSolicitudes.querySelectorAll('.dropdown-item').length;
  countElem.textContent = nuevasSolicitudes;
}

document.addEventListener('click', function(e) {
  if (e.target.matches('.aceptar-btn')) {
    const solicitudId = e.target.dataset.id;
    fetch("{% url 'users:aceptar_amistad' 0 %}".replace('0', solicitudId), {
      method: 'POST',
      headers: {
        'X-CSRFToken': '{{ csrf_token }}',
        'X-Requested-With': 'XMLHttpRequest',
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({}),  // Enviar body vacío para POST
    })
    .then(res => {
      console.log('Respuesta HTTP recibida:', res);
      if (!res.ok) {
        throw new Error('HTTP error ' + res.status);
      }
      return res.text();  // Primero obtener texto para ver qué recibimos
    })
    .then(text => {
      console.log('Texto recibido en respuesta:', text);
      try {
        const data = JSON.parse(text);  // Intentar parsear JSON
        console.log('JSON parseado correctamente:', data);
        if (data.status === 'ok') {
          actualizarListaAmigos(data.amigos);
          actualizarSolicitudesPendientes(data.solicitud_id);
        } else {
          alert('Error al aceptar la solicitud');
        }
      } catch(err) {
        console.error('Error al parsear JSON:', err);
        alert('Respuesta no es un JSON válido');
      }
    })
    .catch(err => {
      console.error('Error capturado en fetch:', err);
      alert('Error de red al aceptar la solicitud');
    });
  }

  if (e.target.matches('.rechazar-btn')) {
    const solicitudId = e.target.dataset.id;
    fetch("{% url 'users:rechazar_amistad' 0 %}".replace('0', solicitudId), {
      method: 'POST',
      headers: {
        'X-CSRFToken': '{{ csrf_token }}',
        'X-Requested-With': 'XMLHttpRequest',
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({}),
    })
    .then(res => {
      console.log('Respuesta HTTP recibida (rechazar):', res);
      if (!res.ok) {
        throw new Error('HTTP error ' + res.status);
      }
      return res.text();
    })
    .then(text => {
      console.log('Texto recibido (rechazar):', text);
      try {
        const data = JSON.parse(text);
        console.log('JSON parseado (rechazar):', data);
        if (data.status === 'ok') {
          actualizarSolicitudesPendientes(data.solicitud_id);
        } else {
          alert('Error al rechazar la solicitud');
        }
      } catch(err) {
        console.error('Error al parsear JSON (rechazar):', err);
        alert('Respuesta no es un JSON válido');
      }
    })
    .catch(err => {
      console.error('Error capturado en fetch (rechazar):', err);
      alert('Error de red al rechazar la solicitud');
    });
  }
});
})
</script>
{% endblock %}
