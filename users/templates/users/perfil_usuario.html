{% extends "base.html" %}
{% load static %}
{% load recetas_extras %}

{% block title %}Perfil de {{ otro.username }} – FoodieNet{% endblock %}

{% block content %}
<div class="container mx-auto my-8 px-4">

  <!-- Contenedor perfil -->
  <h2 class="text-3xl font-bold mb-6 text-gray-900">Perfil de {{ otro.username }}</h2>

  <div class="bg-white rounded-xl p-6 shadow-lg flex flex-col md:flex-row items-center md:items-start gap-6">

    <!-- Foto -->
    {% if perfil_otro.foto %}
      <img src="{{ perfil_otro.foto.url }}" 
           alt="Foto de {{ otro.username }}" 
           class="w-24 h-24 rounded-full object-cover border-2 border-gray-300 shadow-md">
    {% else %}
      <img src="{% static 'perfiles/default.jpeg' %}" 
           alt="Foto de perfil por defecto" 
           class="w-24 h-24 rounded-full object-cover border-2 border-gray-300 shadow-md">
    {% endif %}

    <!-- Información -->
    <div class="flex-1 text-gray-900">
      <p class="mb-2"><strong>Biografía:</strong> {{ perfil_otro.biografia|default:"(sin biografía)" }}</p>

      <input type="hidden" id="csrf-token-input" value="{{ csrf_token }}">

      <div id="solicitud-container" class="mt-2 space-x-2">
        {% if es_amigo %}
          <button id="btn-borrar-amigo"
            type="button"
            class="bg-red-500 hover:bg-red-600 text-white text-sm px-4 py-2 rounded-lg flex items-center gap-2 font-semibold shadow-md hover:shadow-lg active:scale-95 transition-all duration-150"
            data-username="{{ otro.username }}"
            data-url="{% url 'users:borrar_amigo' otro.username %}">
            Borrar amigo
          </button>

        {% elif solicitud_pendiente %}
          <button id="btn-cancelar-solicitud"
            type="button"
            class="bg-gray-500 hover:bg-gray-600 text-white text-sm px-4 py-2 rounded-lg flex items-center gap-2 font-semibold shadow-md hover:shadow-lg active:scale-95 transition-all duration-150"
            data-username="{{ otro.username }}"
            data-url-cancelar="{% url 'users:cancelar_solicitud' otro.username %}">
            Cancelar solicitud
          </button>

        {% elif request.user != otro and request.user.is_authenticated %}
          <button id="btn-enviar-solicitud"
            type="button"
            class="mt-2 px-5 py-2 rounded-lg bg-blue-600 text-white font-semibold shadow-md hover:bg-blue-700 hover:shadow-lg active:scale-95 transition-transform duration-150 flex items-center gap-2"
            data-username="{{ otro.username }}"
            data-url="{% url 'users:enviar_solicitud' otro.username %}">
            <i class="bi bi-person-plus-fill"></i>
            Enviar solicitud de amistad
          </button>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Recomendaciones y debug fuera del contenedor -->
  <div id="recomendaciones_after_like" class="mt-4"></div>
  
      <!-- SCRIPT INLINE -->
<script>
(function(){
  // ===== Utilidades =====
  function log(msg){
    const box = document.getElementById('debug-log');
    const time = new Date().toLocaleTimeString();
    console.log(msg);
    if (box) { box.textContent += `[${time}] ${msg}\n`; box.scrollTop = box.scrollHeight; }
  }

  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

  function getCsrfToken() {
    const fromCookie = getCookie('csrftoken');
    const fromInput = (document.getElementById('csrf-token-input') || {}).value;
    return fromCookie || (fromInput && fromInput !== 'NOTPROVIDED' ? fromInput : null);
  }

  // Username del perfil (fallback si el botón no lo trae)
  function getPerfilUsername(){
    // 1) Intenta leer de un botón visible
    const btn = document.querySelector('#btn-enviar-solicitud, #btn-cancelar-solicitud');
    if (btn && btn.dataset && btn.dataset.username) return btn.dataset.username;
    // 2) Parsear de la URL: /users/<username>/
    const m = window.location.pathname.match(/\/users\/([^\/]+)\//i);
    return m ? decodeURIComponent(m[1]) : '';
  }

  // Construcción de URLs por nombre (por si faltan en data-*)
  function buildEnviarUrl(username){ return `/users/agregar/${encodeURIComponent(username)}/`; }
  function buildCancelarUrl(username){ return `/users/cancelar-solicitud/${encodeURIComponent(username)}/`; }

  // ===== Fabricas de botones (mismo estilo SIEMPRE) =====
  function crearBotonEnviarSolicitud(username){
    const urlEnviar = buildEnviarUrl(username);
    const urlCancelar = buildCancelarUrl(username);
    return `
      <button id="btn-enviar-solicitud"
        type="button"
        class="mt-2 px-5 py-2 rounded-lg bg-blue-600 text-white font-semibold shadow-md hover:bg-blue-700 hover:shadow-lg active:scale-95 transition-transform duration-150 flex items-center gap-2"
        data-username="${username}"
        data-url-enviar="${urlEnviar}"
        data-url-cancelar="${urlCancelar}">
  <i class="bi bi-person-plus-fill"></i> Enviar solicitud de amistad
</button>
    `;
  }

  function crearBotonCancelarSolicitud(username){
    const urlCancelar = buildCancelarUrl(username);
    return `
      <button id="btn-cancelar-solicitud"
        type="button"
        class="mt-2 px-5 py-2 rounded-lg bg-gray-500 text-white font-semibold shadow-md hover:bg-gray-600 hover:shadow-lg active:scale-95 transition-transform duration-150 flex items-center gap-2"
        data-username="${username}"
        data-url-cancelar="${urlCancelar}">
  <i class="bi bi-x-circle-fill"></i> Cancelar solicitud
</button>
    `;
  }
function crearBotonBorrarAmigo(username){
  const url = `/users/borrar-amigo/${encodeURIComponent(username)}/`;
  return `
    <button id="btn-borrar-amigo"
        type="button"
        class="mt-2 px-5 py-2 rounded-lg bg-red-600 text-white font-semibold shadow-md hover:bg-red-700 hover:shadow-lg active:scale-95 transition-transform duration-150 flex items-center gap-2"
        data-username="${username}"
        data-url="${url}">
  <i class="bi bi-person-dash-fill"></i> Borrar amigo
</button>
  `;
}

// ===== Función borrar amigo =====
async function borrarAmigo(url, btn){
  const csrf = getCsrfToken();
  if (!url) { alert('URL no configurada'); return; }

  btn.disabled = true;
  btn.dataset._html = btn.innerHTML;
  btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span> Eliminando...';

  try {
    const resp = await fetch(url, {
      method: 'POST',
      headers: {
        'X-CSRFToken': csrf || '',
        'X-Requested-With': 'XMLHttpRequest',
        'Accept': 'application/json'
      },
      credentials: 'same-origin'
    });

    const raw = await resp.text();
    let data = null;
    try { data = JSON.parse(raw); } catch(e){}

    if (!resp.ok || !data || data.status !== 'ok'){
      alert((data && data.message) || 'Error al borrar amigo');
      return;
    }

    // Sustituir por botón "Enviar solicitud"
    const username = btn.dataset.username || getPerfilUsername();
    const contSol = document.getElementById('solicitud-container');
    if (contSol) contSol.innerHTML = crearBotonEnviarSolicitud(username);

  } catch(err){
    alert('Error en la conexión.');
  } finally {
    btn.disabled = false;
    if (btn.dataset._html) btn.innerHTML = btn.dataset._html;
  }
}
  
  // ===== Llamadas =====
  async function enviarSolicitud(url, btn){
    const csrf = getCsrfToken();
    if (!url) { alert('URL no configurada'); return; }

    btn.disabled = true;
    btn.dataset._html = btn.innerHTML;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span> Enviando...';

    try {
      const resp = await fetch(url, {
        method: 'POST',
        headers: {
          'X-CSRFToken': csrf || '',
          'X-Requested-With': 'XMLHttpRequest',
          'Accept': 'application/json'
        },
        credentials: 'same-origin'
      });

      const raw = await resp.text();
      let data = null;
      try { data = JSON.parse(raw); } catch(e){}

      if (!resp.ok || !data){
        alert('Respuesta inesperada del servidor.');
        return;
      }
      if (data.status !== 'ok') {
        alert(data.message || 'Error al enviar solicitud');
        return;
      }

      // Sustituir por botón "Cancelar"
      const username = btn.dataset.username || getPerfilUsername();
      const contSol = document.getElementById('solicitud-container');
      if (contSol) contSol.innerHTML = crearBotonCancelarSolicitud(username);

      // Recomendaciones (como antes)
      const contRec = document.getElementById('recomendaciones_after_like');
      if (contRec) {
        contRec.innerHTML = '';

        const recs = Array.isArray(data.recomendaciones) ? data.recomendaciones : [];

        if (recs.length) {
          const wrapper = document.createElement('div');
          wrapper.classList.add('mt-4');

          const h = document.createElement('h5');
          h.textContent = 'Quizá también te interesen estas cuentas';
          h.classList.add('text-lg', 'font-semibold', 'mb-3');
          wrapper.appendChild(h);

          const row = document.createElement('div');
          row.className = 'grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4';

          recs.forEach(u => {
            const card = document.createElement('div');
            card.className = 'flex flex-col items-center bg-white rounded-xl shadow hover:shadow-lg transition-shadow p-4 cursor-pointer';

            const img = document.createElement('img');
            img.src = u.foto_url;
            img.width = 72;
            img.height = 72;
            img.className = 'rounded-full object-cover border-2 border-gray-200 mb-2';

            const a = document.createElement('a');
            a.href = u.perfil_url;
            a.textContent = u.username;
            a.className = 'font-semibold text-gray-800 hover:text-blue-500 text-center';

            card.appendChild(img);
            card.appendChild(a);
            row.appendChild(card);
          });

          wrapper.appendChild(row);
          contRec.appendChild(wrapper);
        } else {
          const p = document.createElement('p');
          p.textContent = 'No se han encontrado sugerencias por ahora.';
          p.className = 'text-gray-500 text-sm';
          contRec.appendChild(p);
        }
      }

    } catch (err) {
      alert('Error en la conexión.');
    } finally {
      btn.disabled = false;
      if (btn.dataset._html) btn.innerHTML = btn.dataset._html;
    }
  }

  async function cancelarSolicitud(url, btn){
    const csrf = getCsrfToken();
    if (!url) { alert('URL no configurada'); return; }

    btn.disabled = true;
    btn.dataset._html = btn.innerHTML;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span> Cancelando...';

    try {
      const resp = await fetch(url, {
        method: 'POST',
        headers: {
          'X-CSRFToken': csrf || '',
          'X-Requested-With': 'XMLHttpRequest',
          'Accept': 'application/json'
        },
        credentials: 'same-origin'
      });

      const raw = await resp.text();
      let data = null;
      try { data = JSON.parse(raw); } catch(e){}

      if (!resp.ok || !data || data.status !== 'ok'){
        alert((data && data.message) || 'Error al cancelar solicitud');
        return;
      }

      // Volver al botón "Enviar solicitud" (idéntico al original)
      const username = btn.dataset.username || getPerfilUsername();
      const contSol = document.getElementById('solicitud-container');
      if (contSol) contSol.innerHTML = crearBotonEnviarSolicitud(username);

    } catch(err){
      alert('Error en la conexión.');
    } finally {
      btn.disabled = false;
      if (btn.dataset._html) btn.innerHTML = btn.dataset._html;
    }
  }

  // ===== Delegación única + guardas anti-doble click =====
  document.addEventListener('click', function(e){
    const btn = e.target.closest('#btn-enviar-solicitud, #btn-cancelar-solicitud, #btn-borrar-amigo');

    if (!btn) return;

    // Evita dobles clics
    if (btn.dataset.busy === '1' || btn.disabled) {
      e.preventDefault();
      return;
    }
    btn.dataset.busy = '1';
    e.preventDefault();

    const username = btn.dataset.username || getPerfilUsername();

    if (btn.id === 'btn-enviar-solicitud') {
      // Usa data-url-enviar si existe; si no, construye
      const url = btn.dataset.urlEnviar || btn.dataset.url || buildEnviarUrl(username);
      enviarSolicitud(url, btn).finally(()=> { delete btn.dataset.busy; });
    } else if (btn.id === 'btn-cancelar-solicitud') {
      // Usa data-url-cancelar si existe; si no, construye
      const url = btn.dataset.urlCancelar || buildCancelarUrl(username);
      cancelarSolicitud(url, btn).finally(()=> { delete btn.dataset.busy; });
    }
      else if(btn.id === 'btn-borrar-amigo') {
       
        const username = btn.dataset.username; // asegúrate de tenerlo en el HTML
        const url = btn.dataset.url || `/users/borrar-amigo/${encodeURIComponent(username)}/`;

        borrarAmigo(url, btn)
            .finally(() => { delete btn.dataset.busy; });
    }
    
  }, { passive: false });

  log('Script de perfil iniciado.');
})();
</script>


<h2 class="text-3xl font-bold text-gray-900 mt-10 mb-6">Recetas de {{ otro.username }}</h2>

{% if recetas_publicas or es_amigo and recetas_privadas %}
  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8 mt-6">
    
    {% for r in recetas_publicas %}
      <div class="bg-white rounded-xl shadow-md hover:shadow-xl transition overflow-hidden">
        {% if r.imagen %}
          <img src="{{ r.imagen.url }}" alt="{{ r.titulo }}" class="w-full h-56 object-cover">
        {% else %}
          <div class="w-full h-56 bg-gray-100 flex items-center justify-center text-gray-400 text-4xl">
            📷
          </div>
        {% endif %}
        <div class="p-5">
          <h3 class="text-xl font-semibold text-gray-800 flex items-center gap-2 mb-3">
            <a href="{% url 'detalle_receta' r.pk %}" class="hover:text-indigo-600 transition">
              {{ r.titulo }}
            </a>
            {% if r.es_publica %}
              <span class="inline-block bg-green-500 text-white text-sm px-3 py-1 rounded-full font-semibold shadow-lg">
                Pública
              </span>
            {% else %}
              <span class="inline-block bg-red-500 text-white rounded-full text-xs px-2 py-1">
                Privada
              </span>
            {% endif %}
          </h3>

          <div class="flex items-center gap-3 mb-3">
            <img src="{{ r.autor.perfil.get_foto_url }}" alt="{{ r.autor.username }}" class="w-10 h-10 rounded-full object-cover border border-gray-200">
            <a href="{% url 'users:perfil_usuario' r.autor.username %}" class="text-gray-700 font-medium hover:text-indigo-600 transition">
              {{ r.autor.username }}
            </a>
          </div>

          <p class="text-gray-600 leading-relaxed">{{ r.descripcion|truncatewords:25 }}</p>
        </div>
      </div>
    {% endfor %}

    {% if es_amigo %}
      {% for r in recetas_privadas %}
        <div class="bg-white rounded-xl shadow-md hover:shadow-xl transition overflow-hidden border border-yellow-400">
          {% if r.imagen %}
            <img src="{{ r.imagen.url }}" alt="{{ r.titulo }}" class="w-full h-56 object-cover">
          {% else %}
            <div class="w-full h-56 bg-gray-100 flex items-center justify-center text-gray-400 text-4xl">
              📷
            </div>
          {% endif %}
          <div class="p-5">
            <h3 class="text-xl font-semibold text-gray-800 flex items-center gap-2 mb-3">
              <a href="{% url 'detalle_receta' r.pk %}" class="hover:text-indigo-600 transition">
                {{ r.titulo }}
              </a>
              <span class="inline-block bg-yellow-400 text-gray-800 text-sm px-3 py-1 rounded-full font-semibold">
                Privada
              </span>
            </h3>

            <div class="flex items-center gap-3 mb-3">
              <img src="{{ r.autor.perfil.get_foto_url }}" alt="{{ r.autor.username }}" class="w-10 h-10 rounded-full object-cover border border-gray-200">
              <a href="{% url 'perfil_usuario' r.autor.username %}" class="text-gray-700 font-medium hover:text-indigo-600 transition">
                {{ r.autor.username }}
              </a>
            </div>

            <p class="text-gray-600 leading-relaxed">{{ r.descripcion|truncatewords:25 }}</p>
          </div>
        </div>
      {% endfor %}
    {% endif %}

  </div>
{% else %}
  <p class="text-gray-800 mt-2">No hay recetas disponibles para mostrar.</p>
{% endif %}

</div> <!-- 🔑 cierro el container general -->
{% endblock %}