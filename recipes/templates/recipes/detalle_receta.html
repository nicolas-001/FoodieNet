{% extends "base.html" %}

{% block title %}{{ receta.titulo }} - FoodieNet{% endblock %}

{% block content %}
  <h1>{{ receta.titulo }}</h1>
  <p><small>üëÅÔ∏è Visitas: {{ receta.visitas }}</small></p>

  <div style="display:flex; align-items:center; gap:8px; margin-bottom:16px;">
    <img
      src="{{ receta.autor.perfil.foto.url }}"
      alt="Foto de perfil de {{ receta.autor.username }}"
      style="width:50px; height:50px; border-radius:50%; object-fit:cover;"
    >
    <p><strong>Autor:</strong> {{ receta.autor.username }}</p>
  </div>

  <p>
    <strong>Dificultad:</strong> {{ receta.dificultad }} &nbsp; | &nbsp;
    <strong>Tiempo:</strong> {{ receta.tiempo_preparacion }} minutos &nbsp; | &nbsp;
    <strong>Raciones:</strong> {{ receta.raciones }}
  </p>

  {% if receta.tags.count %}
    <p>
      <strong>Tags:</strong>
      {% for tag in receta.tags.all %}
        <span style="background:#eee; padding:2px 6px; margin-right:4px; border-radius:4px; font-size:0.9em;">
          {{ tag.name }}
        </span>
      {% endfor %}
    </p>
  {% endif %}

  <p><strong>Descripci√≥n:</strong> {{ receta.descripcion }}</p>
  <p><strong>Ingredientes:</strong> {{ receta.ingredientes }}</p>
  <p><strong>Pasos:</strong> {{ receta.pasos }}</p>

  {% if receta.imagen %}
    <div style="margin:16px 0;">
      <img
        src="{{ receta.imagen.url }}"
        alt="{{ receta.titulo }}"
        width="300"
        style="object-fit:cover; border-radius:8px;"
      >
    </div>
  {% endif %}

  <p><strong>Fecha de creaci√≥n:</strong> {{ receta.fecha_creacion|date:"d M Y H:i" }}</p>

  {% if user.is_authenticated and user == receta.autor %}
    <p><a href="{% url 'editar_receta' receta.pk %}">‚úèÔ∏è Editar receta</a></p>
  {% endif %}

  <hr>

  {% if user.is_authenticated %}
    <form method="post" action="{% url 'toggle_like' receta.pk %}" style="display:inline;">
      {% csrf_token %}
      <button type="submit" style="background:none; border:none; cursor:pointer; font-size:1.2em;">
        {% if liked %}‚ù§Ô∏è{% else %}ü§ç{% endif %} {{ receta.total_likes }}
      </button>
    </form>

    <form method="post" action="{% url 'toggle_favorito' receta.pk %}" style="display:inline; margin-left:16px;">
      {% csrf_token %}
      <button type="submit" style="background:none; border:none; cursor:pointer; font-size:1.2em;">
        {% if favorited %}‚òÖ{% else %}‚òÜ{% endif %} {{ receta.total_favs }}
      </button>
    </form>
  {% else %}
    <p>
      <a href="{% url 'authentication:login' %}?next={% url 'detalle_receta' receta.pk %}">
        Inicia sesi√≥n
      </a> para dar like o favorito.
    </p>
  {% endif %}

  <hr class="my-6">

  <button id="btnCalcularMacros" class="btn btn-primary" style="padding:8px 16px; font-size:1em; cursor:pointer;">
    Calcular calor√≠as y macros
  </button>

  <div id="resultadosMacros" style="margin-top:16px; font-size:1em; color:#333;"></div>

  <hr class="my-6">

  <h3>Comentarios ({{ receta.comentarios.count }})</h3>

  {% if user.is_authenticated %}
    <form method="post" action="" class="mb-4">
      {% csrf_token %}
      {{ form.texto.errors }}
      {{ form.texto }}
      <button type="submit" class="mt-2 px-4 py-2 bg-blue-600 text-white rounded">Publicar comentario</button>
    </form>
  {% else %}
    <p>
      <a href="{% url 'authentication:login' %}?next={% url 'detalle_receta' receta.pk %}">Inicia sesi√≥n</a> para dejar un comentario.
    </p>
  {% endif %}

  <ul class="space-y-4">
    {% for c in comentarios %}
      <li class="border p-4 rounded">
        <p class="text-sm text-gray-600">
          <strong>{{ c.autor.username }}</strong>
          <span class="ml-2">{{ c.creado|date:"d M Y H:i" }}</span>
        </p>
        <p>{{ c.texto }}</p>
      </li>
    {% empty %}
      <li>No hay comentarios todav√≠a. ¬°S√© el primero!</li>
    {% endfor %}
  </ul>

  <hr>
  <p><a href="{% url 'lista_recetas' %}">‚Üê Volver a la lista de recetas</a></p>

  <script>
    document.getElementById("btnCalcularMacros").addEventListener("click", function() {
      const resultadosDiv = document.getElementById("resultadosMacros");
      resultadosDiv.innerText = "Calculando... ‚è≥";

      fetch(`/calcular_calorias/{{ receta.id }}/`)
        .then(response => {
          if (!response.ok) throw new Error("Error al calcular macros");
          return response.json();
        })
        .then(data => {
          if (data.status === "ok") {
            let html = `
              <p>‚úÖ <strong>C√°lculo completado:</strong></p>
              <ul>
                <li>Calor√≠as: ${data.calorias.toFixed(2)} kcal</li>
                <li>Prote√≠nas: ${data.proteinas.toFixed(2)} g</li>
                <li>Grasas: ${data.grasas.toFixed(2)} g</li>
                <li>Carbohidratos: ${data.carbohidratos.toFixed(2)} g</li>
              </ul>
            `;

            if (data.detalle_por_ingrediente && data.detalle_por_ingrediente.length > 0) {
              html += "<h4>Detalle por ingrediente:</h4><ul>";
              data.detalle_por_ingrediente.forEach(ing => {
                html += `
                  <li>
                    <strong>${ing.nombre}</strong>:
                    ${ing.calorias.toFixed(2)} kcal,
                    ${ing.proteinas.toFixed(2)} g prote√≠nas,
                    ${ing.grasas.toFixed(2)} g grasas,
                    ${ing.carbohidratos.toFixed(2)} g carbohidratos
                  </li>
                `;
              });
              html += "</ul>";
            }

            resultadosDiv.innerHTML = html;
          } else {
            resultadosDiv.innerText = "Error al calcular macros.";
          }
        })
        .catch(error => {
          resultadosDiv.innerText = "‚ùå " + error.message;
        });
    });
  </script>
{% endblock %}
