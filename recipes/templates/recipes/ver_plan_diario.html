{% extends "base.html" %}
{% block content %}
<div class="container mx-auto my-10 px-4">

    <!-- TÃ­tulo del plan -->
    <div class="text-center mb-10">
        <h2 class="text-4xl font-extrabold text-gray-800 mb-2">{{ plan.nombre }}</h2>
        <p class="text-gray-500 text-lg">CalorÃ­as totales: <span class="font-semibold">{{ total_calorias }} kcal</span></p>
    </div>

    <!-- Lista de Recetas -->
    <div class="mb-10">
        <h3 class="text-2xl font-semibold text-gray-800 mb-4">Recetas del plan</h3>
        <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6">
            {% for receta in plan.recetas.all %}
                {% if receta.pk %}
                <a href="{% url 'detalle_receta' receta.pk %}" class="block transform hover:-translate-y-1 hover:shadow-lg transition duration-300">
                    <div class="border rounded-xl overflow-hidden shadow-sm bg-white hover:bg-gray-50 transition-colors">
                        {% if receta.imagen %}
                            <img src="{{ receta.imagen.url }}" alt="{{ receta.titulo }}" class="w-full h-32 object-cover">
                        {% else %}
                            <div class="w-full h-32 flex items-center justify-center bg-gray-200 text-gray-500 text-2xl">
                                ðŸ“·
                            </div>
                        {% endif %}
                        <div class="p-4 space-y-1">
                            <strong class="text-gray-900">{{ receta.titulo }}</strong>
                            <p class="text-sm text-gray-600 mt-1">{{ receta.calorias_por_persona|floatformat:0 }} kcal</p>
                            <p class="text-xs text-gray-500">
                                <span class="text-blue-600">P: {{ receta.proteinas_por_persona|floatformat:1 }}g</span> Â· 
                                <span class="text-green-600">G: {{ receta.grasas_por_persona|floatformat:1 }}g</span> Â· 
                                <span class="text-orange-600">C: {{ receta.carbohidratos_por_persona|floatformat:1 }}g</span>
                            </p>
                        </div>
                    </div>
                </a>
                {% endif %}
            {% empty %}
            <p class="text-gray-500">No hay recetas en este plan.</p>
            {% endfor %}
        </div>
    </div>

    <!-- Lista de Platos Personalizados -->
    <div class="mb-10">
        <h3 class="text-2xl font-semibold text-gray-800 mb-4">Platos personalizados</h3>
        <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6">
            {% for plato in plan.platos_personalizados.all %}
            <div class="border rounded-xl overflow-hidden shadow-sm bg-white p-4">
                <strong class="text-gray-900">{{ plato.nombre }}</strong>
                <p class="text-sm text-gray-600 mt-1">
                    {{ plato.calorias|floatformat:0 }} kcal
                    {% if plato.cantidad %} x {{ plato.cantidad|floatformat:1 }} = {{ plato.calorias|floatformat:0|floatformat:"0"|add:"0" }} kcal{% endif %}
                </p>
                <p class="text-xs text-gray-500">
                    <span class="text-blue-600">P: {{ plato.proteinas|floatformat:1 }}g</span> Â· 
                    <span class="text-green-600">G: {{ plato.grasas|floatformat:1 }}g</span> Â· 
                    <span class="text-orange-600">C: {{ plato.carbohidratos|floatformat:1 }}g</span>
                </p>
            </div>
            {% empty %}
            <p class="text-gray-500">No hay platos personalizados en este plan.</p>
            {% endfor %}
        </div>
    </div>

    {% if tdee %}
    <!-- InformaciÃ³n TDEE y recomendaciones -->
    <div class="grid md:grid-cols-2 gap-6 mb-10">
        <!-- Tarjeta TDEE -->
        <div class="bg-gradient-to-r from-green-100 to-green-50 shadow-lg rounded-xl p-6 transform hover:-translate-y-1 transition-transform duration-300">
            <h3 class="text-2xl font-semibold mb-3 text-green-800">Tu TDEE</h3>
            <p class="text-gray-700 text-lg"><span class="font-bold">{{ tdee }} kcal</span></p>
            <p class="text-gray-700 mt-2"><strong>Estado:</strong> {{ estado }}</p>
        </div>

        <!-- Tarjeta Recomendaciones -->
        {% if recomendaciones %}
        <div class="bg-gradient-to-r from-blue-50 to-blue-100 shadow-lg rounded-xl p-6 transform hover:-translate-y-1 transition-transform duration-300">
            <h3 class="text-2xl font-semibold mb-3 text-blue-800">Recomendaciones</h3>
            <ul class="list-disc list-inside text-gray-700 space-y-1">
                {% for r in recomendaciones %}
                    <li>{{ r }}</li>
                {% endfor %}
            </ul>
        </div>
        {% endif %}
    </div>

    <!-- BotÃ³n Premium: Sugerencias de recetas segÃºn objetivo -->
    {% if sugerencias_objetivo %}
    <div class="text-center mb-8">
        <button id="btnSugerencias" class="px-6 py-3 bg-indigo-600 text-white rounded-xl shadow-lg hover:bg-indigo-700 transition">
            ðŸŽ¯ Sugerencias para tu objetivo
        </button>
    </div>

    <!-- Modal de sugerencias -->
    <div id="modalSugerencias" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-2xl max-w-xl w-full p-6 relative shadow-2xl overflow-y-auto max-h-[80vh]">
            <button id="cerrarModal" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800 text-xl font-bold">&times;</button>
            <h3 class="text-2xl font-semibold mb-4 text-gray-800">Sugerencias segÃºn tu objetivo</h3>
            <p class="text-gray-600 mb-4">Objetivo: <span class="font-bold">{{ objetivo_usuario }}</span></p>

            <ul class="space-y-4">
                {% for s in sugerencias_objetivo %}
                    {% if s.tipo == "aÃ±adir" %}
                    <li class="flex justify-between items-center bg-gray-50 p-4 rounded-xl shadow hover:shadow-md transition">
                        <div>
                            <strong class="text-gray-900">{{ s.receta.titulo }}</strong>
                            <p class="text-sm text-gray-600">
                                AÃ±Ã¡dela para cubrir ~{{ s.kcal_objetivo|floatformat:0 }} kcal 
                                (suma {{ s.kcal_receta|floatformat:0 }} kcal por porciÃ³n)
                            </p>
                        </div>
                        <a href="{% url 'detalle_receta' s.receta.pk %}" class="px-3 py-1 bg-green-600 text-white rounded-lg hover:bg-green-700 transition">
                            Ver receta
                        </a>
                    </li>
                    {% elif s.tipo == "sustituir" %}
                    <li class="flex justify-between items-center bg-gray-50 p-4 rounded-xl shadow hover:shadow-md transition">
                        <div>
                            <strong class="text-gray-900">{{ s.receta_original.titulo }}</strong> âž¡ 
                            <strong>{{ s.receta_sugerida.titulo }}</strong>
                            <p class="text-sm text-gray-600">
                                SustitÃºyela para reducir ~{{ s.kcal_objetivo|floatformat:0 }} kcal 
                                (ahorrar {{ s.kcal_reducidas|floatformat:0 }} kcal por porciÃ³n)
                            </p>
                        </div>
                        <a href="{% url 'detalle_receta' s.receta_sugerida.pk %}" class="px-3 py-1 bg-green-600 text-white rounded-lg hover:bg-green-700 transition">
                            Ver receta
                        </a>
                    </li>
                    {% endif %}
                {% empty %}
                    <li class="text-gray-500">No hay sugerencias disponibles para tu objetivo.</li>
                {% endfor %}
            </ul>
        </div>
    </div>
    {% endif %}

    <!-- GrÃ¡fico comparativo calorÃ­as -->
    <div class="bg-white shadow-xl rounded-2xl p-6 mb-10 animate-fadeIn">
        <h3 class="text-2xl font-semibold mb-4 text-gray-800">ComparaciÃ³n CalorÃ­as Plan vs TDEE</h3>
        <canvas id="caloriasChart" class="w-full h-40 sm:h-40 md:h-52 lg:h-56"></canvas>
    </div>

    {% else %}
    <div class="bg-yellow-50 border-l-8 border-yellow-400 text-yellow-800 p-6 rounded-xl text-center mb-10 animate-pulse">
        <em>Completa tu perfil para calcular tu gasto energÃ©tico.</em>
    </div>
    {% endif %}

    <!-- DistribuciÃ³n de macronutrientes -->
    <div class="bg-white shadow-xl rounded-2xl p-6 animate-fadeIn">
        <h3 class="text-2xl font-semibold mb-4 text-gray-800">DistribuciÃ³n de Macronutrientes</h3>
        <canvas id="macrosChart" class="w-full h-30 sm:h-30 md:h-52 lg:h-56"></canvas>
    </div>

</div>

<!-- Animaciones Tailwind -->
<style>
@keyframes fadeIn { from {opacity:0;} to {opacity:1;} }
.animate-fadeIn { animation: fadeIn 1s ease-in-out; }
</style>

<!-- Scripts Chart.js y Modal -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
{% if tdee %}
const ctxCal = document.getElementById('caloriasChart').getContext('2d');
new Chart(ctxCal, {
    type: 'bar',
    data: {
        labels: ['Plan', 'TDEE'],
        datasets: [{ label: 'CalorÃ­as', data: [{{ total_calorias }}, {{ tdee }}], backgroundColor: ['#34D399', '#3B82F6'] }]
    },
    options: { responsive: true, scales: { y: { beginAtZero: true } }, animation: { duration: 1000 } }
});
{% endif %}

const ctx = document.getElementById('macrosChart').getContext('2d');
new Chart(ctx, {
    type: 'pie',
    data: {
        labels: ['ProteÃ­nas', 'Grasas', 'Carbohidratos'],
        datasets: [{ data: [{{ total_prot }}, {{ total_grasas }}, {{ total_carbs }}], backgroundColor: ['#3B82F6', '#EF4444', '#FACC15'] }]
    },
    options: { responsive: true, plugins: { legend: { position: 'bottom' } }, animation: { animateScale: true, animateRotate: true } }
});

// Modal premium
const btnSugerencias = document.getElementById('btnSugerencias');
const modalSugerencias = document.getElementById('modalSugerencias');
const cerrarModal = document.getElementById('cerrarModal');

if (btnSugerencias) btnSugerencias.addEventListener('click', () => modalSugerencias.classList.remove('hidden'));
if (cerrarModal) cerrarModal.addEventListener('click', () => modalSugerencias.classList.add('hidden'));
modalSugerencias?.addEventListener('click', (e) => { if (e.target === modalSugerencias) modalSugerencias.classList.add('hidden'); });
</script>
{% endblock %}
