{% extends "base.html" %}

{% block content %}

{% if recomendaciones %}
<section class="my-10">
  <div class="bg-white border border-indigo-100 shadow-lg rounded-2xl p-6">
    <h2 class="text-2xl font-bold text-indigo-700 flex items-center gap-2 mb-6">
      üéØ Recomendaciones para ti
    </h2>
    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6">
      {% for receta in recomendaciones %}
      <div class="bg-white rounded-xl shadow-md hover:shadow-xl transition overflow-hidden min-h-[350px]">
        {% if receta.imagen %}
          <img src="{{ receta.imagen.url }}" alt="{{ receta.titulo }}" class="w-full h-56 object-cover">
        {% else %}
          <div class="w-full h-56 flex items-center justify-center bg-gray-200 text-gray-500 text-4xl">üì∑</div>
        {% endif %}
        <div class="p-4">
          <h3 class="text-lg font-semibold text-gray-800 mb-1">
            <a href="{% url 'detalle_receta' receta.pk %}" class="hover:text-indigo-600 transition">
              {{ receta.titulo }}
            </a>
          </h3>
          <p class="text-sm text-gray-500 mb-2">
            {% if tipo_recomendacion == "likes" %}
              Basado en tus √∫ltimos likes
            {% else %}
              Recetas populares para ti
            {% endif %}
          </p>
          <p class="text-gray-600 text-sm">{{ receta.descripcion|truncatewords:20 }}</p>
        </div>
      </div>
      {% endfor %}
    </div>
  </div>
</section>
{% endif %}

<div class="container mx-auto px-4 my-10">
  <div class="flex justify-between items-center mb-8">
    <h1 class="text-3xl font-bold text-gray-800">üç¥ Lista de Recetas</h1>
    {% if user.is_authenticated %}
      <a href="{% url 'crear_receta' %}" class="bg-indigo-600 text-white px-4 py-2 rounded-lg shadow hover:bg-indigo-700 transition">‚ûï Crear nueva receta</a>
    {% endif %}
  </div>

  <!-- Filtros con autocomplete de tags -->
  <form method="get" class="flex gap-4 mb-6 relative">
    <!-- Input de b√∫squeda de tags -->
    <div class="flex-1 relative">
      <input 
        type="text" 
        id="filter-tags" 
        name="tag" 
        placeholder="Buscar tag..." 
        autocomplete="off"
        value="{{ tag_seleccionado }}"
        class="w-full border rounded-lg p-2">

      <ul id="tags-suggestions" class="absolute z-10 bg-white border border-gray-300 w-full mt-1 rounded-lg max-h-40 overflow-y-auto hidden">
        {% for tag in tags_disponibles %}
          <li class="p-2 cursor-pointer hover:bg-indigo-100" data-value="{{ tag.name }}">{{ tag.name }}</li>
        {% endfor %}
      </ul>
    </div>

    <select name="dificultad" class="border rounded-lg p-2">
      <option value="">Todas las dificultades</option>
      <option value="f√°cil" {% if dificultad_seleccionada == "f√°cil" %}selected{% endif %}>F√°cil</option>
      <option value="media" {% if dificultad_seleccionada == "media" %}selected{% endif %}>Media</option>
      <option value="dif√≠cil" {% if dificultad_seleccionada == "dif√≠cil" %}selected{% endif %}>Dif√≠cil</option>
    </select>

    <button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded-lg shadow hover:bg-indigo-700 transition">
      Filtrar
    </button>
  </form>

  {% if page_obj %}
    <div id="recetas-container">
      {% include 'recipes/_recetas_lista.html' %}
    </div>

    <!-- Paginaci√≥n -->
    <div class="flex justify-center items-center gap-2 mt-10 text-gray-600">
      {% if page_obj.has_previous %}
        <a href="?page=1&{{ query_params }}" class="px-3 py-1 rounded-lg bg-gray-100 hover:bg-indigo-100">&laquo;&laquo;</a>
        <a href="?page={{ page_obj.previous_page_number }}&{{ query_params }}" class="px-3 py-1 rounded-lg bg-gray-100 hover:bg-indigo-100">&laquo;</a>
      {% else %}
        <span class="px-3 py-1 text-gray-400">&laquo;&laquo;</span>
        <span class="px-3 py-1 text-gray-400">&laquo;</span>
      {% endif %}

      <span class="px-4 py-1 rounded-lg bg-indigo-600 text-white">P√°gina {{ page_obj.number }} / {{ page_obj.paginator.num_pages }}</span>

      {% if page_obj.has_next %}
        <a href="?page={{ page_obj.next_page_number }}&{{ query_params }}" class="px-3 py-1 rounded-lg bg-gray-100 hover:bg-indigo-100">&raquo;</a>
        <a href="?page={{ page_obj.paginator.num_pages }}&{{ query_params }}" class="px-3 py-1 rounded-lg bg-gray-100 hover:bg-indigo-100">&raquo;&raquo;</a>
      {% else %}
        <span class="px-3 py-1 text-gray-400">&raquo;</span>
        <span class="px-3 py-1 text-gray-400">&raquo;&raquo;</span>
      {% endif %}
    </div>
  {% else %}
    <p class="text-gray-500 mt-8 text-center">No hay recetas disponibles.</p>
  {% endif %}
</div>

<script>
const inputTag = document.getElementById('filter-tags');
const suggestions = document.getElementById('tags-suggestions');
const tagsList = Array.from(suggestions.querySelectorAll('li'));

// Mostrar y filtrar sugerencias
inputTag.addEventListener('input', () => {
  const value = inputTag.value.toLowerCase();
  let visible = false;
  tagsList.forEach(li => {
    if (li.dataset.value.toLowerCase().includes(value) && value !== '') {
      li.style.display = 'block';
      visible = true;
    } else {
      li.style.display = 'none';
    }
  });
  suggestions.style.display = visible ? 'block' : 'none';
});

// Seleccionar sugerencia al hacer click
tagsList.forEach(li => {
  li.addEventListener('click', () => {
    inputTag.value = li.dataset.value;
    suggestions.style.display = 'none';
  });
});

// Cerrar lista si se hace click fuera
document.addEventListener('click', (e) => {
  if (!inputTag.contains(e.target) && !suggestions.contains(e.target)) {
    suggestions.style.display = 'none';
  }
});
</script>

{% endblock %}
