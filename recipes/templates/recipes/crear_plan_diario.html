{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="container mt-4">
    <h2>{% if form.instance.pk %}Editar{% else %}Crear{% endif %} Plan Diario</h2>

    <form method="post">
        {% csrf_token %}
        {{ form.non_field_errors }}

        <div class="mb-3">
            {{ form.nombre.label_tag }}
            {{ form.nombre }}
        </div>

        <div class="mb-3">
    <label>Selecciona recetas para tu plan</label>
    <div id="recetas-list">
    {% for receta in form.fields.recetas.queryset %}
        <label class="d-block border p-2 rounded mb-2">
            <input type="checkbox"
                   name="recetas"
                   value="{{ receta.id }}"
                   data-calorias="{{ receta.calorias_por_persona }}"
                   data-proteinas="{{ receta.proteinas_por_persona }}"
                   data-grasas="{{ receta.grasas_por_persona }}"
                   data-carbohidratos="{{ receta.carbohidratos_por_persona }}">
            <strong>{{ receta.titulo }}</strong><br>
            {{ receta.calorias_por_persona|floatformat:0 }} kcal | 
            P: {{ receta.proteinas_por_persona|floatformat:1 }} g · 
            G: {{ receta.grasas_por_persona|floatformat:1 }} g · 
            C: {{ receta.carbohidratos_por_persona|floatformat:1 }} g
        </label>
    {% endfor %}
</div>


        <div class="card p-3 mt-3">
            <h4>Totales del plan</h4>
            <div class="row">
                <div class="col-md-6">
                    <p><strong>Calorías:</strong> <span id="total-calorias">0.0</span> kcal</p>
                    <p><strong>Proteínas:</strong> <span id="total-proteinas">0.0</span> g</p>
                </div>
                <div class="col-md-6">
                    <p><strong>Grasas:</strong> <span id="total-grasas">0.0</span> g</p>
                    <p><strong>Carbohidratos:</strong> <span id="total-carbohidratos">0.0</span> g</p>
                </div>
            </div>
            <button type="submit" class="btn btn-success mt-3">
                {% if form.instance.pk %}Actualizar{% else %}Guardar{% endif %} Plan
            </button>
        </div>
    </form>
</div>

<script>
function actualizarTotales() {
    const checkboxes = document.querySelectorAll('#recetas-list input[type="checkbox"]');
    let calorias = 0, proteinas = 0, grasas = 0, carbohidratos = 0;

    checkboxes.forEach(cb => {
        if (cb.checked) {
            calorias += parseFloat(cb.dataset.calorias) || 0;
            proteinas += parseFloat(cb.dataset.proteinas) || 0;
            grasas += parseFloat(cb.dataset.grasas) || 0;
            carbohidratos += parseFloat(cb.dataset.carbohidratos) || 0;
        }
    });

    document.getElementById('total-calorias').textContent = calorias.toFixed(1);
    document.getElementById('total-proteinas').textContent = proteinas.toFixed(1);
    document.getElementById('total-grasas').textContent = grasas.toFixed(1);
    document.getElementById('total-carbohidratos').textContent = carbohidratos.toFixed(1);
}

document.querySelectorAll('#recetas-list input[type="checkbox"]').forEach(cb => {
    cb.addEventListener('change', actualizarTotales);
});

actualizarTotales();
</script>
{% endblock %}
