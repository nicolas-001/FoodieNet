{% extends "base.html" %}
{% load static %}
{% load widget_tweaks %}

{% block content %}
<div class="max-w-5xl mx-auto px-4 py-8 bg-white rounded-2xl shadow-lg">
  <!-- Header -->
  <div class="mb-6">
    <h2 class="text-2xl font-bold text-gray-800">
      {% if form.instance.pk %}‚úèÔ∏è Editar{% else %}‚ûï Crear{% endif %} Plan Diario
    </h2>
    <p class="text-gray-500 mt-1">Organiza tus recetas y controla los nutrientes de tu d√≠a.</p>
  </div>

  <form method="post" class="space-y-8">
    {% csrf_token %}

    <!-- Nombre del plan -->
    <div>
      <label for="{{ form.nombre.id_for_label }}" class="block text-gray-700 font-medium mb-2">Nombre del Plan</label>
      {{ form.nombre|add_class:"w-full border border-gray-300 rounded-lg p-2 focus:outline-none focus:ring-2 focus:ring-blue-500" }}
    </div>

    <!-- Buscador recetas -->
    <div>
      <label class="block text-gray-700 font-medium mb-2">üîç Buscar receta</label>
      <input type="text" id="buscador-recetas"
             placeholder="Escribe el nombre de la receta..."
             class="w-full border border-gray-300 rounded-lg p-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
      <div id="resultados-recetas" class="mt-2 max-h-80 overflow-y-auto border border-gray-200 rounded-lg bg-white shadow-sm hidden"></div>
    </div>

    <!-- Recetas seleccionadas -->
    <div>
      <h3 class="text-lg font-semibold text-gray-800 mb-3">Recetas seleccionadas</h3>
      <div id="recetas-seleccionadas" class="space-y-4"></div>
    </div>

    <!-- Platos personalizados -->
    <div>
      <h3 class="text-lg font-semibold text-gray-800 mb-3">A√±adir platos personalizados</h3>

      {% if platos_usuario %}
      <div class="mb-4">
        <label class="block text-gray-700 font-medium mb-2">üìÇ Mis platos personalizados</label>
        <select id="select-plato-guardado" class="w-full border border-gray-300 rounded-lg p-2">
          <option value="">-- Selecciona un plato guardado --</option>
          {% for plato in platos_usuario %}
          <option value="{{ plato.id }}"
                  data-nombre="{{ plato.nombre }}"
                  data-calorias="{{ plato.calorias }}"
                  data-proteinas="{{ plato.proteinas }}"
                  data-grasas="{{ plato.grasas }}"
                  data-carbohidratos="{{ plato.carbohidratos }}">
            {{ plato.nombre }} ({{ plato.calorias }} kcal, P:{{ plato.proteinas }}g, G:{{ plato.grasas }}g, C:{{ plato.carbohidratos }}g)
          </option>
          {% endfor %}
        </select>
      </div>
      {% endif %}

      <div id="platos-personalizados" class="space-y-4"></div>
      <button type="button" id="add-plato" class="mt-2 bg-blue-500 text-white px-4 py-2 rounded-lg shadow hover:bg-blue-600 transition">
        ‚ûï A√±adir plato manual
      </button>
    </div>

    <!-- Totales -->
    <div class="bg-gradient-to-r from-blue-50 to-blue-100 rounded-xl shadow p-6">
      <h4 class="text-lg font-bold text-gray-800 mb-4">Totales del Plan</h4>
      <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
        <div class="bg-white p-4 rounded-lg shadow">
          <p class="text-sm text-gray-500">Calor√≠as</p>
          <p class="text-xl font-semibold text-gray-800"><span id="total-calorias">0.0</span> kcal</p>
        </div>
        <div class="bg-white p-4 rounded-lg shadow">
          <p class="text-sm text-gray-500">Prote√≠nas</p>
          <p class="text-xl font-semibold text-blue-600"><span id="total-proteinas">0.0</span> g</p>
        </div>
        <div class="bg-white p-4 rounded-lg shadow">
          <p class="text-sm text-gray-500">Grasas</p>
          <p class="text-xl font-semibold text-green-600"><span id="total-grasas">0.0</span> g</p>
        </div>
        <div class="bg-white p-4 rounded-lg shadow">
          <p class="text-sm text-gray-500">Carbohidratos</p>
          <p class="text-xl font-semibold text-orange-600"><span id="total-carbohidratos">0.0</span> g</p>
        </div>
      </div>

      <div class="mt-6 text-center">
        <button type="submit" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-lg shadow-lg transition duration-300">
          {% if form.instance.pk %}Actualizar{% else %}Guardar{% endif %} Plan
        </button>
      </div>
    </div>
  </form>
</div>

<script>
// === Actualizar totales ===
function actualizarTotales() {
    let calorias = 0, proteinas = 0, grasas = 0, carbohidratos = 0;

    // Recetas
    document.querySelectorAll('#recetas-seleccionadas input[name="recetas"]').forEach(input => {
        calorias += parseFloat(input.dataset.calorias || 0);
        proteinas += parseFloat(input.dataset.proteinas || 0);
        grasas += parseFloat(input.dataset.grasas || 0);
        carbohidratos += parseFloat(input.dataset.carbohidratos || 0);
    });

    // Platos personalizados
    document.querySelectorAll('.plato-input').forEach(plato => {
        const cantidad = parseFloat(plato.querySelector('.cantidad')?.value || 1);
        calorias += parseFloat(plato.querySelector('.calorias')?.value || 0) * cantidad;
        proteinas += parseFloat(plato.querySelector('.proteinas')?.value || 0) * cantidad;
        grasas += parseFloat(plato.querySelector('.grasas')?.value || 0) * cantidad;
        carbohidratos += parseFloat(plato.querySelector('.carbohidratos')?.value || 0) * cantidad;
    });

    document.getElementById('total-calorias').textContent = calorias.toFixed(1);
    document.getElementById('total-proteinas').textContent = proteinas.toFixed(1);
    document.getElementById('total-grasas').textContent = grasas.toFixed(1);
    document.getElementById('total-carbohidratos').textContent = carbohidratos.toFixed(1);
}

// === Crear input de plato ===
function crearPlatoInput(data={}) {
    const div = document.createElement("div");
    div.classList.add("grid", "grid-cols-6", "gap-2", "plato-input", "items-center");

    div.innerHTML = `
        <input type="text" name="plato_nombre[]" value="${data.nombre || ''}" placeholder="Nombre" class="col-span-2 border border-gray-300 rounded-lg p-2">
        <input type="number" name="plato_calorias[]" value="${data.calorias || ''}" placeholder="kcal" step="0.1" class="calorias border border-gray-300 rounded-lg p-2">
        <input type="number" name="plato_proteinas[]" value="${data.proteinas || ''}" placeholder="P (g)" step="0.1" class="proteinas border border-gray-300 rounded-lg p-2">
        <input type="number" name="plato_grasas[]" value="${data.grasas || ''}" placeholder="G (g)" step="0.1" class="grasas border border-gray-300 rounded-lg p-2">
        <input type="number" name="plato_carbohidratos[]" value="${data.carbohidratos || ''}" placeholder="C (g)" step="0.1" class="carbohidratos border border-gray-300 rounded-lg p-2">
        <input type="number" name="plato_cantidad[]" value="1" step="0.1" class="cantidad border border-gray-300 rounded-lg p-2 w-20">
        <button type="button" class="eliminar bg-red-500 hover:bg-red-600 text-white rounded-full w-6 h-6 flex items-center justify-center text-sm">√ó</button>
    `;

    div.querySelectorAll("input").forEach(input => input.addEventListener("input", actualizarTotales));
    div.querySelector(".eliminar").addEventListener("click", () => {
        div.remove();
        actualizarTotales();
    });

    return div;
}

// === A√±adir plato manual ===
document.getElementById("add-plato").addEventListener("click", () => {
    const container = document.getElementById("platos-personalizados");
    container.appendChild(crearPlatoInput());
    actualizarTotales();
});

// === Reutilizar platos guardados ===
const selectPlato = document.getElementById("select-plato-guardado");
if (selectPlato) {
    selectPlato.addEventListener("change", () => {
        const option = selectPlato.options[selectPlato.selectedIndex];
        if (option.value) {
            const data = {
                nombre: option.dataset.nombre,
                calorias: option.dataset.calorias,
                proteinas: option.dataset.proteinas,
                grasas: option.dataset.grasas,
                carbohidratos: option.dataset.carbohidratos
            };
            const container = document.getElementById("platos-personalizados");
            container.appendChild(crearPlatoInput(data));
            selectPlato.selectedIndex = 0;
            actualizarTotales();
        }
    });
}

// === Buscador din√°mico de recetas ===
const buscador = document.getElementById("buscador-recetas");
const resultados = document.getElementById("resultados-recetas");
const seleccionadas = document.getElementById("recetas-seleccionadas");

buscador.addEventListener("input", async () => {
    const query = buscador.value.trim();
    if (!query) {
        resultados.classList.add("hidden");
        resultados.innerHTML = "";
        return;
    }

    const res = await fetch(`/api/recetas/?search=${query}`);
    const data = await res.json();

    resultados.innerHTML = "";
    data.forEach(r => {
        const div = document.createElement("div");
        div.className = "flex items-center justify-between p-2 hover:bg-gray-100 cursor-pointer border-b border-gray-200";
        div.innerHTML = `
            <div class="flex items-center gap-2">
                <img src="${r.imagen || '/static/perfiles/default.jpeg'}" class="w-12 h-12 object-cover rounded" />
                <div>
                  <div class="font-semibold text-gray-800">${r.titulo}</div>
                  <div class="text-xs text-gray-500">C:${r.calorias} kcal ¬∑ P:${r.proteinas}g ¬∑ G:${r.grasas}g ¬∑ C:${r.carbohidratos}g</div>
                </div>
            </div>
            <button type="button" data-id="${r.id}" class="text-blue-600 font-semibold">A√±adir</button>
        `;
        resultados.appendChild(div);

        div.querySelector("button").addEventListener("click", () => {
            const recetaDiv = document.createElement("div");
            recetaDiv.className = "flex items-center justify-between p-2 border rounded shadow bg-white";
            recetaDiv.innerHTML = `
                <div class="flex items-center gap-2">
                    <span>${r.titulo}</span>
                    <input type="hidden" name="recetas" value="${r.id}"
                        data-calorias="${r.calorias}" data-proteinas="${r.proteinas}" data-grasas="${r.grasas}" data-carbohidratos="${r.carbohidratos}">
                </div>
                <span class="text-xs text-gray-500">C:${r.calorias} kcal ¬∑ P:${r.proteinas}g ¬∑ G:${r.grasas}g ¬∑ C:${r.carbohidratos}g</span>
            `;
            seleccionadas.appendChild(recetaDiv);
            div.remove();
            resultados.classList.add("hidden");
            actualizarTotales();
        });
    });

    resultados.classList.remove("hidden");
});

// === Inicializar totales al cargar ===
actualizarTotales();
</script>
{% endblock %}
